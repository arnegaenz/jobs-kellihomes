# Kelli Homes Job Management - Exhaustive Summary (2026-01-15)

## Purpose
Create a static job management portal (GitHub Pages) with a Lightsail backend (Node + Postgres + S3). This includes job CRUD, documents with types and trash/restore, line items, and a KH-branded login gate. The front-end is vanilla HTML/CSS/JS.

## Front-end repository (GitHub Pages)
Repo: `https://github.com/arnegaenz/jobs-kellihomes`
Site: `https://jobs.kellihomes.com` (GitHub Pages, HTTPS enforced)

### Key files
- `index.html` — Dashboard + job creation form
- `job.html` — Job detail view with edit form + line items + documents
- `documents.html` — Dedicated documents list page
- `styles.css` — Unified KH brand styling
- `config.js` — API base URL config
- `api.js` — API client wrapper
- `main.js` — UI logic + login gate
- `assets/kh-logo.png` — KH logo
- `CNAME` — `jobs.kellihomes.com`

### Visual/brand specs implemented
- Background white / light off-white; text `#222`; muted `#6b6b6b`.
- Accent `#C28152`, used for primary buttons and pill borders.
- Cards: white, 6–8px radius, soft shadow.
- Typography: `system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`.
- Header: KH logo (72px height), minimal nav, signed-in user label.
- Footer: “Copyright © 2026 Kelli Homes - All Rights Reserved.”

## Login gate (client-side)
- Users allowed (hard-coded):
  - arne / $yd3JAC9
  - raquel / elizabeth1
  - justin / Aryna2026
- Logic in `main.js`:
  - stored in `localStorage` if available; fallback in-memory if blocked
  - overlay appears when unauthenticated
  - hides nav, footer, and main content

## Job data model (front-end)
Fields used across create/edit/detail:
- id, name, location (job address), client
- clientEmail, clientPhone
- stage, type, status
- startDate, targetCompletion
- primaryContact, health
- financials (contractValue, supplements, costsToDate, projectedMargin, marginStatus)
- milestones (array of { title, date, status })

## Job stages (dropdown)
- Preconstruction
- Permitting
- Groundbreaking
- In Construction
- Punch List
- Warranty
- Closed

## Job status (dropdown)
- Not Started
- In Progress
- On Hold
- Completed

## Job type (dropdown)
- Insurance Restoration
- Custom Build
- Remodel
- Other

## Client validation & formatting
- Email: basic pattern check
- Phone: allows digits/spaces/+().-, must have >= 7 digits
- Display/submit format for 10 digits: `(###) ###-####`
- Date pickers blur after selection

## Line items
- Full catalog of line items in `main.js` (LINE_ITEM_CATALOG) for the job detail page
- Job creation does NOT require line items (removed from create form)

## Documents (front-end)
### Document types (dropdown)
- Approved Planset
- Cabinet Plans
- Permit
- Insurance Estimate
- Contract / Agreement
- Change Order
- Photos
- Invoice
- Inspection / Signoff
- Warranty Docs

### Document icons
Each type maps to an inline SVG icon in `main.js`:
- blueprint, stamp, shield, file, swap, camera, receipt, check, warranty

### Documents page (`documents.html`)
- Filters: job + type + “Show trash”
- Displays all documents across jobs
- Inline document type dropdown per row (auto-save)
- Shows size + date and icon

### Job detail documents
- Upload requires type selection
- List shows type + date, icon, and “Move to trash / Restore”
- Trashed docs are dimmed and hidden by default

### Stage gating (Approved Planset)
- UI and API prevent setting stage to “In Construction” unless an “Approved Planset” doc exists
- Trashed docs do NOT count

## Backend (AWS Lightsail)
### Instance
- Name: `kh-jobs-api`
- Region: `us-west-2a` (Oregon)
- OS: Ubuntu 22.04
- Size: micro
- Static IP: `44.238.21.97`

### API host
- Domain: `https://api.jobs.kellihomes.com`
- Nginx reverse proxy: 80/443 → Node on port 3000
- HTTPS via Let’s Encrypt (Certbot)

### Database
- Lightsail managed Postgres: `kh-jobs-db`
- DB name: `kh_jobs`
- User: `kh_admin`
- Password stored in `secrets/credentials.txt`
- Public access enabled for connection from instance

### S3
- Bucket: `kh-jobs-documents-807940873467`
- CORS: allows `https://jobs.kellihomes.com` and `https://arnegaenz.github.io`

## Backend service (Node/Express)
Location on server: `/home/ubuntu/kh-jobs-api`

### Dependencies
- express, cors, dotenv, pg
- @aws-sdk/client-s3, @aws-sdk/s3-request-presigner

### Process manager
- PM2 started as root
- Env loaded from `/home/ubuntu/kh-jobs-api/.env`

### API endpoints
- `GET /health` → `{ status: "ok" }`
- `GET /jobs`
- `POST /jobs`
- `GET /jobs/:id`
- `PUT /jobs/:id`
- `DELETE /jobs/:id`
- `GET /jobs/:id/line-items`
- `PUT /jobs/:id/line-items`
- `GET /jobs/:id/documents?includeTrashed=true|false`
- `POST /jobs/:id/documents/upload`
- `DELETE /jobs/:id/documents/:docId` (soft delete)
- `POST /jobs/:id/documents/:docId/restore`
- `GET /documents?includeTrashed=true|false`
- `PUT /documents/:docId` (update document_type)

### API behaviors
- Jobs are persisted in Postgres.
- Line items stored in `line_items` table, replaced on PUT.
- Documents stored in `documents` with S3 key + metadata.
- Document uploads: API returns presigned URL for direct S3 PUT.
- Soft delete: sets `deleted_at`, does NOT remove from S3.

## Database schema (Postgres)

### `jobs`
- id (PK)
- name
- location
- client
- client_email
- client_phone
- stage
- type
- status
- start_date
- target_completion
- primary_contact
- health
- financials (JSONB)
- milestones (JSONB)
- created_at
- updated_at

### `line_items`
- job_id (FK)
- code
- name
- budget
- actual
- status
- vendor
- notes

### `documents`
- id (PK)
- job_id (FK)
- name
- url
- storage_key
- content_type
- size
- document_type
- deleted_at
- created_at

## DNS & SSL
- `jobs.kellihomes.com` → GitHub Pages (`arnegaenz.github.io`) with HTTPS enforced
- `api.jobs.kellihomes.com` → Lightsail static IP `44.238.21.97` with Let’s Encrypt

## Known behaviors
- GitHub Pages HTTPS had to be enabled once GitHub issued cert.
- Job creation can redirect before DB read is ready; front-end now retries job load before showing “Job not found.”
- Login is client-side only; must be replaced with real auth if public.

## Local secrets (ignored)
Location: `secrets/credentials.txt` (NOT committed)
Includes:
- login users
- DB credentials
- IAM S3 access keys

## Important reminders
- The document trash feature is soft-delete only.
- “Approved Planset” is required to move a job to “In Construction.”
- CORS configured for front-end origins.

